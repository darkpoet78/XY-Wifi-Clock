<!DOCTYPE html>

<html lang="en">

<head>

   <meta charset="utf-8">

   <meta name="viewport" content="width=device-width, initial-scale=1">

   <title>XY-Wifi Clock</title>

   <style>
	   body { font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }
	   label { font-size: 14px; font-weight: normal; width:180px; display: inline-block; }
	   span {font-size: 14px; font-weight: normal; }
	   th { font-size: 14px; font-weight: bold; }
	   td { font-size: 14px; text-align: center; }
	   button { font-size: 14px; font-weight: bold; cursor: pointer; background-color: #e1ecf4; border-radius: 3px; color: #2c5777; border: 1px solid #7aa7c7; box-sizing: border-box; padding: 8px 12px; }
	   fieldset {font-size: 20px; font-weight: bold; display: inline-block; }
	   h1 {font-size: 26px;}
	   h3 {font-size: 16px;}
	   textarea {resize: none; }
   </style>

   <script>
	   function checkBrowserSupported()
	   {
		   "use strict";

		   try { eval("var foo = (x)=>x+1"); }
		   catch (e) { return false; }
		   return true;
	   }

	   if (!checkBrowserSupported())
	   {
		   alert("Your browser is outdated and unfortunately is not supported.");
	   }
   </script>

</head>

<body>

<h1>XY-Wifi Clock</h1>

<form>
   <fieldset>
	  <legend>Status</legend>

	  <br/>

	  <label for="SSID">SSID</label>
	  <input type="text" id="SSID" name="SSID" readonly><br/><br/>

	  <label for="IP">IP Address</label>
	  <input type="text" id="IP" name="IP" readonly><br/><br/>

	  <label for="RSSI">RSSI (dBm)</label>
	  <input type="text" id="RSSI" name="RSSI" readonly><br/><br/>

	  <label for="NTP">Last NTP Update</label>
	  <input type="text" id="NTP" name="NTP" readonly><br/><br/>

	  <label for="RESET" style="vertical-align: top" >Last Reset</label>
	  <textarea id="RESET" name="RESET" cols="28" rows="2" readonly></textarea><br/><br/>

	  <label for="BRIGHTNESS">Brightness</label>
	  <span>Dim <input id="current_brightness" class="slider" type="range" min="1" max="8" value="4"/> Bright</span>
   </fieldset>

   <br/><br/>

   <fieldset>
	  <legend>Config</legend>


	  <h3>General</h3>
	  <label for="deviceName">Device Name</label>
	  <input type="text" id="deviceName" name="deviceName" maxlength="15"/><br/><br/>

	  <label for="timezone">Timezone</label>
	  <select id="timezone" name="timezone"></select><br/><br/>

	  <label for="displayMode">Time Format</label>
	  <select id="displayMode" name="displayMode"></select><br/><br/>

	  <label for="dateFormat">Date Format</label>
	  <select id="dateFormat" name="dateFormat"></select><br/><br/>

	  <label for="alarmSound">Alarm Sound</label>
	  <select id="alarmSound" name="alarmSound"></select><br/><br/>

	  <label for="snoozeTime">Snooze Time (minutes)</label>
	  <select id="snoozeTime" name="snoozeTime"></select><br/><br/>

	  <h3>Auto-Brightness Settings</h3>
	  <label for="autoBrightness">Auto-Brightness Enable</label>
	  <input id="autoBrightness" name="autoBrightness" type="checkbox"><br/><br/>

	  <div id="day-brightness-section">
		 <label for="day-start" style="width: 95px">Day Start</label>
		 <select id="day-start" class="hour"></select>
		 &emsp;<select class="minute"></select>
		 &emsp;<select class="AmPm"></select>
		 <span style="padding-left: 40px">Dim <input id="day-start-brightness" class="brightness" type="range" min="1" max="8" value="4"/> Bright</span>
	  </div>
	  <div id="night-brightness-section">
		 <label for="night-start" style="width: 95px">Night Start</label>
		 <select id="night-start" class="hour"></select>
		 &emsp;<select class="minute"></select>
		 &emsp;<select class="AmPm"></select>
		 <span style="padding-left: 40px">Dim <input id="night-start-brightness" class="brightness" type="range" min="1" max="8" value="4"/> Bright</span>
	  </div>
	  <br/>


	  <h3>Alarms</h3>
	  <table id="alarms-table">
		 <thead>
			<tr>
			   <th>Enable</th>
			   <th style="padding-left: 40px">Hour</th>
			   <th style="padding-left: 15px">Min</th>
			   <th style="padding-left: 15px">AM/PM</th>
			   <th style="padding-left: 20px">Mon</th>
			   <th style="padding-left: 5px">Tue</th>
			   <th style="padding-left: 5px">Wed</th>
			   <th style="padding-left: 5px">Thu</th>
			   <th style="padding-left: 5px">Fri</th>
			   <th style="padding-left: 5px">Sat</th>
			   <th style="padding-left: 5px">Sun</th>
			</tr>
		 </thead>
		 <tbody>
			<tr>
			   <td><input  class="enable" type="checkbox"></td>
			   <td style="padding-left: 40px"><select class="hour"></select></td>
			   <td style="padding-left: 15px"><select class="minute"></select></td>
			   <td style="padding-left: 15px"><select class="AmPm"></select></td>
			   <td style="padding-left: 20px"><input  class="mon" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="tue" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="wed" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="thu" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="fri" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="sat" type="checkbox"></td>
			   <td style="padding-left: 5px"><input	 class="sun" type="checkbox"></td>
			</tr>
		 </tbody>
	  </table>
	  <br/>

	  <br/>
	  <div style="width:540px; text-align: center">
		 <button id="save" type="button">Save</button>
	  </div>
   </fieldset>

</form>

<script type="application/javascript">

	var alarmRowTemplate = document.querySelector("#alarms-table tbody tr");

	var timezones = [];

	var displayModes = [];

	var dateFormats = [];

	var alarmSounds = [];

	var statusUpdateInterval;


	function writeDebugText(message)
	{
		event = new Date;

		message = event.getHours() + ":" + event.getMinutes() + ":" + event.getSeconds() + "." + event.getMilliseconds() +	" - " + message;

		return fetch("/debug",
		{
			method: 'POST',
			headers: { 'Content-Type': 'text/plain' },
			body: message
		});
	}


	function loadConfig(firstTime)
	{
		fetch("/config",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then(config => displayConfig(config, firstTime));
	}


	function displayConfig(config, firstTime)
	{
		document.getElementById("deviceName").value		  = config.deviceName;
		document.getElementById("timezone").value		  = config.timezone;
		document.getElementById("displayMode").value	  = config.displayMode;
		document.getElementById("dateFormat").value		  = config.dateFormat;
		document.getElementById("alarmSound").value		  = config.alarmSound;
		document.getElementById("snoozeTime").value       = config.snoozeTime;
		document.getElementById("autoBrightness").checked = config.autoBrightness;

		if (firstTime)
		{
			setupAlarms();
		}

		if (config.dayBrightness)
		{
			setBrightness(document.getElementById("day-brightness-section"), config.dayBrightness);
		}

		if (config.nightBrightness)
		{
			setBrightness(document.getElementById("night-brightness-section"), config.nightBrightness);
		}

		if (config.alarms)
		{
			for (var i = 0; i < config.alarms.length; i++)
			{
				var alarm = config.alarms[i];

				var tr = document.querySelectorAll("#alarms-table tbody tr")[i];

				tr.querySelector(".enable").checked = alarm.enable;
				tr.querySelector(".hour").value		= convertHour24to12(parseInt(alarm.hour));
				tr.querySelector(".minute").value	= alarm.minute;
				tr.querySelector(".AmPm").value		= convertAmPm24to12(parseInt(alarm.hour));
				tr.querySelector(".mon").checked	= alarm.daysOfWeek[0];
				tr.querySelector(".tue").checked	= alarm.daysOfWeek[1];
				tr.querySelector(".wed").checked	= alarm.daysOfWeek[2];
				tr.querySelector(".thu").checked	= alarm.daysOfWeek[3];
				tr.querySelector(".fri").checked	= alarm.daysOfWeek[4];
				tr.querySelector(".sat").checked	= alarm.daysOfWeek[5];
				tr.querySelector(".sun").checked	= alarm.daysOfWeek[6];
			}
		}
	}


	function loadStatus()
	{
		fetch("/status",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then(status => displayStatus(status));
	}


	function displayStatus(status)
	{
		document.getElementById("SSID").value	= status.SSID;
		document.getElementById("IP").value		= status.IP;
		document.getElementById("RSSI").value	= status.RSSI;
		document.getElementById("NTP").value	= status.NTP;
		document.getElementById("RESET").value	= status.RESET;
		document.querySelector(".slider").value = status.BRIGHTNESS;
	}


	function setBrightness(brightnessSection, brightnessConfig)
	{
		brightnessSection.querySelector(".hour").value		 = convertHour24to12(parseInt(brightnessConfig.hour));
		brightnessSection.querySelector(".minute").value	 = brightnessConfig.minute;
		brightnessSection.querySelector(".AmPm").value		 = convertAmPm24to12(parseInt(brightnessConfig.hour));
		brightnessSection.querySelector(".brightness").value = brightnessConfig.brightness;
	}


	function getBrightness(brightnessSection, brightnessConfig)
	{
		brightnessConfig.hour		= convertHour12to24(parseInt(brightnessSection.querySelector(".hour").value),
														brightnessSection.querySelector(".AmPm").value);
		brightnessConfig.minute		= parseInt(brightnessSection.querySelector(".minute").value);
		brightnessConfig.brightness = parseInt(brightnessSection.querySelector(".brightness").value);
	}


	function getConfigFromForm()
	{
		data =
		{
			deviceName: document.getElementById("deviceName").value,
			timezone: document.getElementById("timezone").value,
			displayMode: document.getElementById("displayMode").value,
			dateFormat: document.getElementById("dateFormat").value,
			alarmSound: document.getElementById("alarmSound").value,
			snoozeTime:	document.getElementById("snoozeTime").value,
			autoBrightness: document.getElementById("autoBrightness").checked,
			dayBrightness:	 { hour: 0, minute: 0, brightness: 4 },
			nightBrightness: { hour: 0, minute: 0, brightness: 4 },
			alarms: []
		};

		getBrightness(document.getElementById("day-brightness-section"), data.dayBrightness);
		getBrightness(document.getElementById("night-brightness-section"), data.nightBrightness);

		var trs = document.querySelectorAll("#alarms-table tbody tr");

		for (var i = 0; i < trs.length; i++)
		{
			var tr = trs[i];
			var alarm =
			{
				enable: tr.querySelector(".enable").checked,
				hour: convertHour12to24(parseInt(tr.querySelector(".hour").value), tr.querySelector(".AmPm").value),
				minute: parseInt(tr.querySelector(".minute").value),
				daysOfWeek: [false, false, false, false, false, false, false]
			};

			alarm.daysOfWeek[0] = tr.querySelector(".mon").checked;
			alarm.daysOfWeek[1] = tr.querySelector(".tue").checked;
			alarm.daysOfWeek[2] = tr.querySelector(".wed").checked;
			alarm.daysOfWeek[3] = tr.querySelector(".thu").checked;
			alarm.daysOfWeek[4] = tr.querySelector(".fri").checked;
			alarm.daysOfWeek[5] = tr.querySelector(".sat").checked;
			alarm.daysOfWeek[6] = tr.querySelector(".sun").checked;

			data.alarms.push(alarm);
		}

		return data;
	}


	function sendReset()
	{
		if (confirm("Reset the clock?"))
		{
			var bodyText = new String("ResetNow");

			return fetch("/reset",
			{
				method: 'POST',
				headers: { 'Content-Type': 'text/plain' },
				body: bodyText
			});
		}
	}


	function saveConfig()
	{
		var data = getConfigFromForm();
		var json = JSON.stringify(data);

		document.getElementById("save").innerHTML = "Saving...";

		clearInterval(statusUpdateInterval);

		return fetch("/config",
		{
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: json
		})
		.then(() => setTimeout(saveDone, 2000));
	}


	function saveDone()
	{
		document.getElementById("save").innerHTML = "Save";
		loadConfig(false);
		statusUpdateInterval = setInterval(loadStatus, 1000);
	}


	function isTimeFormat24(format)
	{
		return (format.startsWith("24"));
	}


	function isTimeFormat12(format)
	{
		return (format.startsWith("12"));
	}


	function isTimeSetting24(setting)
	{
		return (setting === "--");
	}


	function isTimeSettingAM(setting)
	{
		return (setting === "AM");
	}


	function isTimeSettingPM(setting)
	{
		return (setting === "PM");
	}


	function convertHour24to12(hour)
	{
		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat12(currentTimeFormat))
		{
			if (hour == 0)
			{
				hour  = 12;
			}
			else if (hour > 12)
			{
				hour -= 12;
			}
		}

		return (hour);
	}


	function convertAmPm24to12(hour)
	{
		var AmPm;

		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat24(currentTimeFormat))
		{
			AmPm = "--";
		}
		else
		{
			if (hour < 12)
			{
				AmPm = "AM";
			}
			else
			{
				AmPm = "PM";
			}
		}

		return (AmPm);
	}


	function convertHour12to24(hour, AmPm)
	{
		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat12(currentTimeFormat))
		{
			if (isTimeSettingAM(AmPm))
			{
				if (hour == 12)
				{
					hour  = 0;
				}
			}
			else
			{
				hour += 12;
			}
		}

		return (hour);
	}


	function adjustHour(hour, AmPm)
	{
		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat24(currentTimeFormat))
		{
			if (isTimeSettingAM(AmPm))
			{
				if (hour == 12)
				{
					hour = 0;
				}
			}
			else if (isTimeSettingPM(AmPm))
			{
				if (hour < 12)
				{
					hour += 12;
				}
			}
		}
		else
		{
			if (isTimeSetting24(AmPm))
			{
				if (hour == 0)
				{
					hour  = 12;
				}
				else if (hour > 12)
				{
					hour -= 12;
				}
			}
		}

		return (hour);
	}


	function adjustAmPm(hour, AmPm)
	{
		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat24(currentTimeFormat))
		{
			AmPm = "--";
		}
		else
		{
			if (isTimeSetting24(AmPm))
			{
				if (hour == 0)
				{
					AmPm  = "AM";
				}
				else if (hour < 12)
				{
					AmPm  = "AM";
				}
				else
				{
					AmPm  = "PM";
				}
			}
		}

		return (AmPm);
	}


	function checkAmPm()
	{
		var alarm;

		alarm =
		{
			hour: parseInt(document.querySelector("#day-brightness-section .hour").value),
			AmPm: document.querySelector("#day-brightness-section .AmPm").value
		};
		populateHours(document.querySelector("#day-brightness-section .hour"));
		populateAmPm(document.querySelector("#day-brightness-section .AmPm"));
		document.querySelector("#day-brightness-section .hour").value = adjustHour(alarm.hour, alarm.AmPm);
		document.querySelector("#day-brightness-section .AmPm").value = adjustAmPm(alarm.hour, alarm.AmPm);

		alarm =
		{
			hour: parseInt(document.querySelector("#night-brightness-section .hour").value),
			AmPm: document.querySelector("#night-brightness-section .AmPm").value
		};
		populateHours(document.querySelector("#night-brightness-section .hour"));
		populateAmPm(document.querySelector("#night-brightness-section .AmPm"));
		document.querySelector("#night-brightness-section .hour").value = adjustHour(alarm.hour, alarm.AmPm);
		document.querySelector("#night-brightness-section .AmPm").value = adjustAmPm(alarm.hour, alarm.AmPm);

		var trs = document.querySelectorAll("#alarms-table tbody tr");
		for (var i = 0; i < trs.length; i++)
		{
			var tr = trs[i];

			alarm =
			{
				hour: parseInt(tr.querySelector(".hour").value),
				AmPm: tr.querySelector(".AmPm").value
			};

			populateHours(tr.querySelector(".hour"));
			populateAmPm(tr.querySelector(".AmPm"));

			tr.querySelector(".hour").value = adjustHour(alarm.hour, alarm.AmPm);
			tr.querySelector(".AmPm").value = adjustAmPm(alarm.hour, alarm.AmPm);
		}
	}


	function changeCurrentBrightness()
	{
		writeDebugText("manual brightness change");

		data =
		{
			newBrightness: parseInt(document.querySelector(".slider").value)
		};
		var json = JSON.stringify(data);

		return fetch("/brightness",
		{
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: json
		});
	}


	function populateHours(select)
	{
		for (var i = 23; i >= 0; i--)
		{
			select.remove(i);
		}

		var currentTimeFormat = document.getElementById("displayMode").value;
		var start;
		var end;
		if (isTimeFormat24(currentTimeFormat))
		{
			start = 0;
			end	  = 23;
		}
		else
		{
			start = 1;
			end	  = 12;
		}

		for (var i = start; i <= end; i++)
		{
			var option	 = document.createElement("option");
			option.value = i;
			option.text	 = new String(i);
			if (option.text.length == 1) option.text = "0" + option.text;

			select.add(option);
		}
	}


	function populateMinutes(select)
	{
		for (var i = 0; i < 60; i++)
		{
			var option	 = document.createElement("option");
			option.value = i;
			option.text	 = new String(i);
			if (option.text.length == 1) option.text = "0" + option.text;

			select.add(option);
		}
	}


	function populateAmPm(select)
	{
		for (var i = 1; i >= 0; i--)
		{
			select.remove(i);
		}

		var currentTimeFormat = document.getElementById("displayMode").value;
		if (isTimeFormat24(currentTimeFormat))
		{
			var option24   = document.createElement("option");
			option24.value = new String("--");
			option24.text  = option24.value;
			select.add(option24);
		}
		else
		{
			var optionAM   = document.createElement("option");
			optionAM.value = new String("AM");
			optionAM.text  = optionAM.value;
			select.add(optionAM);

			var optionPM   = document.createElement("option");
			optionPM.value = new String("PM");
			optionPM.text  = optionPM.value;
			select.add(optionPM);
		}
	}


	function populateAlarmLookups()
	{
		populateHours(alarmRowTemplate.querySelector(".hour"));
		populateMinutes(alarmRowTemplate.querySelector(".minute"));
		populateAmPm(alarmRowTemplate.querySelector(".AmPm"));
	}


	function populateBrightnessLookups()
	{
		populateHours(document.querySelector("#day-brightness-section .hour"));
		populateMinutes(document.querySelector("#day-brightness-section .minute"));
		populateAmPm(document.querySelector("#day-brightness-section .AmPm"));

		populateHours(document.querySelector("#night-brightness-section .hour"));
		populateMinutes(document.querySelector("#night-brightness-section .minute"));
		populateAmPm(document.querySelector("#night-brightness-section .AmPm"));
	}


	function setupAlarms()
	{
		populateBrightnessLookups();
		populateAlarmLookups();

		var rowsToAdd = 6;
		var tableBody = document.querySelector("#alarms-table tbody");

		for (var i = 0; i < rowsToAdd; i++)
		{
			var alarmRow = alarmRowTemplate.cloneNode(true);

			tableBody.appendChild(alarmRow)
		}
	}


	function setupControlEvents()
	{
		var resetControl = document.getElementById("RESET");
		resetControl.addEventListener("dblclick", sendReset);

		var saveButton = document.getElementById("save");
		saveButton.addEventListener("click", saveConfig);

		var timeFormat = document.getElementById("displayMode");
		timeFormat.addEventListener("change", checkAmPm);

		var changeBrightness = document.getElementById("current_brightness");
		changeBrightness.addEventListener("input", changeCurrentBrightness);
	}


	function populateTimezones(select)
	{
		for (var i = 0; i < timezones.length; i++)
		{
			var option	 = document.createElement("option");
			option.value = timezones[i];
			option.text	 = timezones[i];

			select.add(option);
		}
	}


	function loadTimezones()
	{
		return fetch("timezones.json",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then((zones) =>
		{
			timezones = Object.keys(zones);
			populateTimezones(document.getElementById("timezone"));
		});
	}


	function populateDisplayModes(select)
	{
		for (var i = 0; i < displayModes.length; i++)
		{
			var option	 = document.createElement("option");
			option.value = displayModes[i];
			option.text	 = displayModes[i];

			select.add(option);
		}
	}


	function loadDisplayModes()
	{
		return fetch("displayModes.json",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then((modes) =>
		{
			displayModes = Object.keys(modes);
			populateDisplayModes(document.getElementById("displayMode"));
		});
	}


	function populateDateFormats(select)
	{
		for (var i = 0; i < dateFormats.length; i++)
		{
			var option	 = document.createElement("option");
			option.value = dateFormats[i];
			option.text	 = dateFormats[i];

			select.add(option);
		}
	}


	function loadDateFormats()
	{
		return fetch("dateFormats.json",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then((dates) =>
		{
			dateFormats = Object.keys(dates);
			populateDateFormats(document.getElementById("dateFormat"));
		});
	}


	function populateAlarmSounds(select)
	{
		for (var i = 0; i < alarmSounds.length; i++)
		{
			var option = document.createElement("option");
			option.value = alarmSounds[i];
			option.text	 = alarmSounds[i];

			select.add(option);
		}
	}


	function populateSnoozeTime(select)
	{
		for (var i = 1; i <= 15; i++)
		{
			var option	 = document.createElement("option");
			option.value = i;
			option.text	 = new String(i);

			select.add(option);
		}
	}


	function loadAlarmSounds()
	{
		return fetch("alarmSounds.json",
		{
			method: 'GET',
			headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then((sounds) =>
		{
			alarmSounds = Object.keys(sounds);
			populateAlarmSounds(document.getElementById("alarmSound"));
		});
	}


	addEventListener("load", (event) =>
	{
		loadTimezones()
		.then(() =>
		{
			loadDisplayModes()
			.then (() =>
			{
				loadDateFormats()
				.then (() =>
				{
					loadAlarmSounds()
					.then (() =>
					{
						populateSnoozeTime(document.getElementById("snoozeTime"));
						loadConfig(true);
						statusUpdateInterval = setInterval(loadStatus, 1000);
					});
				});
			});
		});

		setupControlEvents();
	});

</script>

</body>

</html>
